{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/recipe-list.css' %}">
<title>Recipe List</title>
{% endblock%}

{% block content %}
{% if page_title %}
  <h2>{{ page_title }}</h2>
{% else %}
  <h2>All Recipes</h2>
{% endif %}

{% if page_title == "All Recipes" %}
<form method="get" class="filter-form">
    <input type="text" name="q" id="q" placeholder="Search recipes..." value = "{{ search_query }}">
    <label for="sort">Sort by:</label>
    <select name="sort" id="sort" onchange="this.form.submit()">
      <option value="-created_at" {% if selected_sort == "-created_at" %}selected{% endif %}>Most Recent</option>
      <option value="title" {% if selected_sort == "title" %}selected{% endif %}>A–Z</option>
      <option value="-title" {% if selected_sort == "-title" %}selected{% endif %}>Z–A</option>
    </select>
  
    <label for="tag">Filter by tag:</label>
    <select name="tag" id="tag" onchange="this.form.submit()">
      <option value="">All</option>
      {% for tag in all_tags %}
        <option value="{{ tag.name }}" {% if tag.name == selected_tag %}selected{% endif %}>
          {{ tag.name }}
        </option>
      {% endfor %}
    </select>

    <button class = "btn" type="submit">Search</button>
</form>
{% endif %}


{% if recipes %}
    <div class="recipe-list">
        {% for recipe in recipes %}
        <div class="recipe-card" data-href="{% url 'recipe_detail' recipe.id %}"> 
            {% if target_collection %}  
            <form action="{% url 'collection_add_recipe' recipe.id %} " method="POST">
                {% csrf_token %}
                <input type="hidden" value ="{{ target_collection.id }}" name="collection_id">
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button 
                    class="add-icon plus-mode" 
                    type="submit" 
                    {% if recipe.id in target_collection_recipe_ids %} disabled {% endif %}
                    title="Add to {{ target_collection.name }}">
                    {% if recipe.id in target_collection_recipe_ids %}
                      <i class="fa-solid fa-check" title="Already in Collection"></i>
                    {% else %}
                      <i class="fa-solid fa-plus" title="Add to Collection"></i>
                    {% endif %}
                </button>
            </form>
            {% else %}
                
            <div class="collection-dropdown-wrapper">                              
                {% if user.is_authenticated %}               
                <button class="add-icon" type="button" data-recipe="{{ recipe.id }}" class="icon">
                    {% if recipe.id in saved_recipe_ids %}
                    <i class="fa-solid fa-bookmark"></i>
                    {% else %}
                    <i class="fa-regular fa-bookmark"></i>
                    {% endif %}
                </button>               
                <div class="collection-dropdown hidden" id="dropdown-{{ recipe.id }}">
                    <form method="POST" action="{% url 'collection_add_recipe' recipe.id %}">
                        {% csrf_token %}
                        <select 
                            name="collection_id" 
                            class = "collection-select" 
                            data-recipe-id="{{ recipe.id}}" 
                            required
                        >
                            <option value="" disabled selected>Select collection</option>
                            {% for collection in user_collections %}
                                {% if recipe in collection.recipes.all %}
                                    <option value="{{ collection.id }}" disabled >
                                    {{ collection.name }} ☑️
                                    </option>
                                {% else %}
                                    <option value="{{ collection.id }}">
                                    {{ collection.name }}
                                    </option>
                                {% endif %}
                            {% endfor %}
                            <option value="__new__">+ New Collection</option>
                        </select>
                        <button type="submit" class="modal-btn">Add</button>
                    </form>            
                </div>
                {% endif %}    
            </div>
            {% endif %}
            
            <div class="recipe-thumb-container">       
                {% if recipe.photo %}
                <img src="{{ recipe.photo.url }}" alt="{{ recipe.title }}" class ="recipe-thumb">
                {% else %}
                <img src="{% static 'img/default_recipe.jpg' %}" alt="{{ recipe.title }}" class ="recipe-thumb">
                {% endif %}  
            </div>  
                           

            <h3>{{ recipe.title }}</h3>
            <p>by {{ recipe.author.username }}</p>
            <p>{{ recipe.description|truncatewords:15 }}</p>

        </div>
        {% endfor %}
    </div>
    {% if is_paginated %}
    <div class="pagination">
        {% if page_obj.has_previous %}
        <a href="?page=1">First</a>
        <a href="?page={{ page_obj.previous_page_number }}">Previous</a>
        {% endif %}

        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">Next</a>
        <a href="?page={{ page_obj.paginator.num_pages }}">Last</a>
        {% endif %}
    </div>
    {% endif %}
    
{% else %}
    {% if request.GET.q or request.GET.tag or request.GET.sort %}
        <p>No recipes match your search or filters.  Try adjusting your criteria</p>
    {% else %}
        <p>No recipes yet. Be the first to add one!</p>
    {% endif %}
{% endif %}



<div id="new-collection-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <form method="POST" action="{% url 'collection_create_inline' %}">
        {% csrf_token %}
        <label for="new-collection-name">New collection name:</label>
        <input type="text" id="new-collection-name" name="name" required>
        <input type="hidden" id="new-collection-recipe-id" name="recipe_id">
        <div class="modal-buttons">
          <button type="submit" class="btn">Create</button>
          <button type="button" id="cancel-modal" class="btn danger-btn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

{% endblock %}

<!-- templates/registration/login.html -->

