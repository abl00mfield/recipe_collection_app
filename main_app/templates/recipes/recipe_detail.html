{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/recipe-detail.css' %}">
<title>Recipe Details</title>
{% endblock%}

{% block content %}
  <div class="recipe-detail">

    <h2 class = "title">{{ recipe.title }}</h2>
    <p><strong>Submitted by:</strong> {{ recipe.author.username }}</p>
    {% if recipe.source %}
        <p><strong>Original Source:</strong>
            <a href="{{ recipe.source }}" target="_blank" rel="noopener noreferrer">
                {{ recipe.source|cut:"https://"|cut:"http://" }}
            </a>
        </p>
    {% endif %}

    {% if recipe.photo %}
      <img src="{{ recipe.photo.url }}" alt="{{ recipe.title }}" class="recipe-photo">
    {% endif %}

    <h3>Description</h3>
    <p>{{ recipe.description }}</p>

    <h3>Ingredients</h3>
    <ul>
        {% for line in recipe.ingredients.splitlines %}
          {% if line %}
            <li>{{ line }}</li>
          {% endif %}
        {% endfor %}
      </ul>

      <h3>Instructions</h3>
      <ol>
        {% for step in recipe.instructions.splitlines %}
          {% if step %}
            <li>{{ step }}</li>
          {% endif %}
        {% endfor %}
      </ol>

    {% if recipe.tags.all %}
      <h3>Tags</h3>
      <ul class="tag-list">
        {% for tag in recipe.tags.all %}
          <li class="tag">{{ tag.name }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if request.user == recipe.author %}
    <div class = "button container">
        <a class = "btn" href="{% url 'recipe_edit' recipe.id %}">Edit</a>
        <a class ="btn danger-btn" href="{% url 'recipe_delete' recipe.id %}">Delete</a>
    </div>
    {% endif %}
    <h3>Average Rating: {{ average_score }} / 5</h3>
    
    {% if user.is_authenticated %}
    <form method="POST">
        {% csrf_token %}

        <div class="star-rating">
            {% for i in "54321"|make_list %}
              <input type="radio" name="score" id="star{{ i }}" value="{{ i }}"
              {% if i|add:"0" == feedback_form.score.value %}checked{% endif %}>
              <label for="star{{ i }}" title="{{ i }} star{{ i|pluralize }}">&#9733;</label>
            {% endfor %}
        </div>

        <div class = "comment">
        {{ feedback_form.comment }}
        </div>

        <button class = "btn" type="submit">Submit Feedback</button>
    </form>
    {% else %}
    <p><a href="{% url 'signin' %}">Sign in</a> to leave a rating and comment.</p>
    {% endif %}
    <h3>Reviews</h3>
    {% if feedbacks %}
    <ul class="feedback-list">
        {% for f in feedbacks %}
        <li>
            <strong>{{ f.user.username }}</strong>
            <span>
            {% for star in "12345"|make_list %}
                {% if forloop.counter <= f.score %}
                ⭐
                {% else %}
                ☆
                {% endif %}
            {% endfor %}
            </span><br>
            {{ f.comment|linebreaks }}
            <small>{{ f.created_at|date:"M d, Y g:i A" }}</small>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>No reviews yet.</p>
    {% endif %}
  </div>
{% endblock %}
